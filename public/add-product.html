<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add New Product - Ai-Maize-ing Nachos</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Shrikhand&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Web App Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#8b4513">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-title" content="Ai-Maize-ing Nachos">
    
    <style>
        /* Additional Styles for Add Product Page */
        .add-product-container {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .add-product-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #ff6b35;
        }
        
        .add-product-header h1 {
            color: #ff6b35;
            font-family: 'Shrikhand', cursive;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .add-product-header p {
            color: #666;
            font-size: 1.1rem;
        }
        
        .product-form {
            display: grid;
            gap: 25px;
        }
        
        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid #ff6b35;
        }
        
        .section-title {
            color: #2c3e50;
            font-size: 1.3rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            color: #ff6b35;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            border-color: #ff6b35;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.2);
            outline: none;
        }
        
        .textarea-control {
            min-height: 100px;
            resize: vertical;
        }
        
        .category-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .category-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .category-option:hover {
            border-color: #ff6b35;
            transform: translateY(-3px);
        }
        
        .category-option.selected {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.1);
        }
        
        .category-option i {
            font-size: 2rem;
            color: #ff6b35;
        }
        
        .image-upload-container {
            border: 3px dashed #bdc3c7;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        
        .image-upload-container:hover {
            border-color: #ff6b35;
            background: rgba(255, 107, 53, 0.05);
        }
        
        .upload-icon {
            font-size: 3rem;
            color: #ff6b35;
            margin-bottom: 15px;
        }
        
        .image-preview {
            max-width: 200px;
            margin: 15px auto;
            display: none;
        }
        
        .image-preview img {
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .ingredient-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .ingredient-item input {
            flex: 1;
        }
        
        .ingredient-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .form-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #ff6b35;
            color: white;
        }
        
        .btn-primary:hover {
            background: #e55a2b;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.3);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .back-to-menu {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .mode-indicator {
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
            text-align: center;
        }
        
        .mode-admin {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .mode-guest {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            margin: 15px 0;
            overflow: hidden;
            display: none;
        }
        
        .progress-fill {
            height: 100%;
            background: #28a745;
            width: 0%;
            transition: width 0.3s;
        }
        
        .upload-steps {
            background: #e8f4fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .upload-steps ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .upload-steps li {
            margin-bottom: 8px;
        }
        
        @media (max-width: 768px) {
            .add-product-container {
                margin: 10px;
                padding: 15px;
                border-radius: 15px;
            }
            
            .category-options {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Small Corner Logo -->
    <div class="corner-logo">
        <img src="image/LOGO.jpg" alt="Ai-Maize-ing Nachos Logo" onerror="this.style.display='none'">
    </div>

    <div class="add-product-container">
        <div class="add-product-header">
            <h1><i class="fas fa-plus-circle"></i> Add New Product</h1>
            <p>Add new items to your menu that will appear in the appropriate category pages</p>
        </div>

        <!-- Mode Indicator -->
        <div id="modeIndicator" class="mode-indicator"></div>

        <!-- Upload Steps Info -->
        <div id="uploadSteps" class="upload-steps" style="display: none;">
            <h4><i class="fas fa-info-circle"></i> Upload Process:</h4>
            <ol>
                <li><strong>Step 1:</strong> Validating form data...</li>
                <li><strong>Step 2:</strong> Uploading image to GitHub...</li>
                <li><strong>Step 3:</strong> Saving product to database...</li>
                <li><strong>Step 4:</strong> Completing...</li>
            </ol>
        </div>

        <!-- Progress Bar -->
        <div id="progressBar" class="progress-bar">
            <div id="progressFill" class="progress-fill"></div>
        </div>

        <!-- Status Message -->
        <div id="statusMessage" class="status-message"></div>

        <form id="productForm" class="product-form">
            <!-- Basic Information -->
            <div class="form-section">
                <h2 class="section-title"><i class="fas fa-info-circle"></i> Product Information</h2>
                
                <div class="form-group">
                    <label for="productName"><i class="fas fa-tag"></i> Product Name *</label>
                    <input type="text" id="productName" class="form-control" placeholder="Enter product name (e.g., Supreme Nachos)" required>
                </div>

                <div class="form-group">
                    <label for="productPrice"><i class="fas fa-dollar-sign"></i> Price *</label>
                    <div style="display: flex; align-items: center;">
                        <span style="background: #ff6b35; color: white; padding: 12px; border-radius: 10px 0 0 10px; font-weight: bold;">₱</span>
                        <input type="number" id="productPrice" class="form-control" placeholder="0.00" step="0.01" min="0" style="border-radius: 0 10px 10px 0;" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="productDescription"><i class="fas fa-align-left"></i> Description</label>
                    <textarea id="productDescription" class="form-control textarea-control" placeholder="Enter product description (optional)" rows="3"></textarea>
                </div>
            </div>

            <!-- Category Selection -->
            <div class="form-section">
                <h2 class="section-title"><i class="fas fa-folder"></i> Select Category *</h2>
                <p style="color: #666; margin-bottom: 15px;">Select where this product will appear:</p>
                
                <div class="category-options">
                    <div class="category-option" data-category="nachos" onclick="selectCategory(this)">
                        <i class="fas fa-utensils"></i>
                        <div>
                            <strong>Nachos</strong>
                            <p style="font-size: 0.9rem; color: #666; margin-top: 3px;">Appears in nachos.html</p>
                        </div>
                    </div>
                    
                    <div class="category-option" data-category="desserts" onclick="selectCategory(this)">
                        <i class="fas fa-ice-cream"></i>
                        <div>
                            <strong>Desserts</strong>
                            <p style="font-size: 0.9rem; color: #666; margin-top: 3px;">Appears in aifoodies.html</p>
                        </div>
                    </div>
                    
                    <div class="category-option" data-category="drinks" onclick="selectCategory(this)">
                        <i class="fas fa-glass-whiskey"></i>
                        <div>
                            <strong>Drinks</strong>
                            <p style="font-size: 0.9rem; color: #666; margin-top: 3px;">New category page</p>
                        </div>
                    </div>
                    
                    <div class="category-option" data-category="specials" onclick="selectCategory(this)">
                        <i class="fas fa-star"></i>
                        <div>
                            <strong>Special Offers</strong>
                            <p style="font-size: 0.9rem; color: #666; margin-top: 3px;">Appears on homepage</p>
                        </div>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label for="customCategory"><i class="fas fa-edit"></i> Custom Category (Optional)</label>
                    <input type="text" id="customCategory" class="form-control" placeholder="Enter custom category name">
                </div>
            </div>

            <!-- Ingredients -->
            <div class="form-section">
                <h2 class="section-title"><i class="fas fa-list-alt"></i> Ingredients</h2>
                
                <div id="ingredientsContainer">
                    <div class="ingredient-item">
                        <input type="text" class="form-control ingredient-input" placeholder="Enter ingredient" required>
                        <button type="button" class="btn btn-danger" onclick="removeIngredient(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>

                <div class="ingredient-actions">
                    <button type="button" class="btn btn-secondary" onclick="addIngredient()">
                        <i class="fas fa-plus"></i> Add Ingredient
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearIngredients()">
                        <i class="fas fa-broom"></i> Clear All
                    </button>
                </div>
            </div>

            <!-- Product Image -->
            <div class="form-section">
                <h2 class="section-title"><i class="fas fa-camera"></i> Product Image</h2>
                
                <div id="imageUploadContainer" class="image-upload-container" onclick="document.getElementById('imageInput').click()">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <h3 style="color: #2c3e50; margin-bottom: 10px;">Click to Upload Product Image</h3>
                    <p style="color: #7f8c8d;">or drag and drop your image here</p>
                    <p style="color: #95a5a6; font-size: 0.9rem; margin-top: 10px;">Supports: JPG, PNG, GIF (Max: 2MB)</p>
                </div>

                <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="previewImage(event)">

                <div id="imagePreview" class="image-preview">
                    <img id="previewImage" src="" alt="Preview">
                    <button type="button" class="btn btn-danger" onclick="removeImage()" style="margin-top: 10px; width: 100%;">
                        <i class="fas fa-trash"></i> Remove Image
                    </button>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="resetForm()">
                    <i class="fas fa-redo"></i> Reset Form
                </button>
                
                <button type="submit" class="btn btn-success" id="submitBtn">
                    <i class="fas fa-save"></i> Save Product
                </button>
            </div>
        </form>

        <div class="back-to-menu">
            <button class="btn btn-primary" onclick="navigateTo('index.html')">
                <i class="fas fa-arrow-left"></i> Back to Home
            </button>
            <button class="btn btn-info" onclick="navigateTo('admin-login.html')" style="margin-left: 10px;">
                <i class="fas fa-user-lock"></i> Admin Login
            </button>
            <button class="btn btn-warning" onclick="navigateTo('manage-products.html')" style="margin-left: 10px;">
                <i class="fas fa-list"></i> Manage Products
            </button>
        </div>
    </div>

    <!-- Modals -->
    <div id="custom-alert" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <p id="custom-alert-message"></p>
            <button id="custom-alert-ok">OK</button>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // Configuration - No GitHub credentials in frontend
        const CONFIG = {
            STORAGE_KEY: 'ai_maize_ing_products',
            IMAGE_STORAGE_KEY: 'ai_maize_ing_images',
            SERVER_URL: window.location.origin,
            
            // API Endpoints
            API_ENDPOINTS: {
                UPLOAD_IMAGE: '/api/admin/upload-image',
                CREATE_PRODUCT: '/api/admin/menu-items',
                GET_PRODUCTS: '/api/menu-items',
                HEALTH: '/api/health'
            }
        };

        let selectedCategory = '';
        let selectedImage = null;
        let selectedImageBase64 = '';
        let isAdminMode = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminStatus();
            checkServerHealth();
            initializeDragAndDrop();
            addIngredient(); // Start with one ingredient field
        });

        // Check server health
        async function checkServerHealth() {
            try {
                const response = await fetch(CONFIG.API_ENDPOINTS.HEALTH);
                if (response.ok) {
                    const data = await response.json();
                    console.log('Server health:', data);
                }
            } catch (error) {
                console.warn('Server health check failed:', error);
            }
        }

        // Check if admin is logged in
        function checkAdminStatus() {
            const adminToken = localStorage.getItem('adminToken');
            const modeIndicator = document.getElementById('modeIndicator');
            
            if (adminToken) {
                isAdminMode = true;
                modeIndicator.className = 'mode-indicator mode-admin';
                modeIndicator.innerHTML = '<i class="fas fa-user-shield"></i> Admin Mode: Products will be saved to server & GitHub';
                document.getElementById('uploadSteps').style.display = 'block';
                showMessage('Admin mode activated! Products will be saved to server and GitHub.', 'success');
            } else {
                isAdminMode = false;
                modeIndicator.className = 'mode-indicator mode-guest';
                modeIndicator.innerHTML = '<i class="fas fa-user"></i> Guest Mode: Products saved locally only. <a href="admin-login.html" style="color: #856404; text-decoration: underline;">Login as admin</a> to save to server.';
                showMessage('Guest mode: Products will be saved locally only. Login as admin to save to server.', 'warning');
            }
        }

        // Add ingredient field
        function addIngredient() {
            const container = document.getElementById('ingredientsContainer');
            const div = document.createElement('div');
            div.className = 'ingredient-item';
            div.innerHTML = `
                <input type="text" class="form-control ingredient-input" placeholder="Enter ingredient" required>
                <button type="button" class="btn btn-danger" onclick="removeIngredient(this)">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            container.appendChild(div);
        }

        // Remove ingredient field
        function removeIngredient(button) {
            const items = document.querySelectorAll('.ingredient-item');
            if (items.length > 1) {
                button.closest('.ingredient-item').remove();
            }
        }

        // Clear all ingredients
        function clearIngredients() {
            const container = document.getElementById('ingredientsContainer');
            container.innerHTML = `
                <div class="ingredient-item">
                    <input type="text" class="form-control ingredient-input" placeholder="Enter ingredient" required>
                    <button type="button" class="btn btn-danger" onclick="removeIngredient(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }

        // Select category
        function selectCategory(element) {
            // Remove selected class from all options
            document.querySelectorAll('.category-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selected class to clicked option
            element.classList.add('selected');
            
            // Get category value
            selectedCategory = element.dataset.category;
            
            console.log('Selected category:', selectedCategory);
        }

        // Preview uploaded image
        function previewImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file size (2MB max)
            if (file.size > 2 * 1024 * 1024) {
                showMessage('File size should be less than 2MB', 'error');
                return;
            }

            // Validate file type
            const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                showMessage('Please upload a valid image file (JPG, PNG, GIF)', 'error');
                return;
            }

            selectedImage = file;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                selectedImageBase64 = e.target.result;
                const preview = document.getElementById('previewImage');
                preview.src = selectedImageBase64;
                document.getElementById('imagePreview').style.display = 'block';
                
                // Update upload container text
                const container = document.getElementById('imageUploadContainer');
                container.querySelector('.upload-icon').innerHTML = '<i class="fas fa-check-circle" style="color: #28a745;"></i>';
                container.querySelector('h3').textContent = 'Image Selected: ' + file.name;
                container.querySelector('p').textContent = 'Click to change image';
            };
            reader.readAsDataURL(file);
        }

        // Remove selected image
        function removeImage() {
            selectedImage = null;
            selectedImageBase64 = '';
            document.getElementById('imageInput').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            
            // Reset upload container
            const container = document.getElementById('imageUploadContainer');
            container.querySelector('.upload-icon').innerHTML = '<i class="fas fa-cloud-upload-alt"></i>';
            container.querySelector('h3').textContent = 'Click to Upload Product Image';
            container.querySelector('p').textContent = 'or drag and drop your image here';
        }

        // Show status message
        function showMessage(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `status-message status-${type}`;
            statusDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                ${message}
            `;
            statusDiv.style.display = 'block';
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Show progress bar
        function showProgress(percentage) {
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            progressBar.style.display = 'block';
            progressFill.style.width = percentage + '%';
            
            // Update steps visibility
            const steps = document.querySelectorAll('#uploadSteps li');
            if (percentage >= 25) steps[0].style.color = '#28a745';
            if (percentage >= 50) steps[1].style.color = '#28a745';
            if (percentage >= 75) steps[2].style.color = '#28a745';
            if (percentage >= 100) steps[3].style.color = '#28a745';
        }

        // Hide progress bar
        function hideProgress() {
            document.getElementById('progressBar').style.display = 'none';
        }

        // Reset form
        function resetForm() {
            if (confirm('Are you sure you want to reset the form? All entered data will be lost.')) {
                document.getElementById('productForm').reset();
                selectedCategory = '';
                selectedImage = null;
                selectedImageBase64 = '';
                
                // Reset category selection
                document.querySelectorAll('.category-option').forEach(option => {
                    option.classList.remove('selected');
                });
                
                // Reset image preview
                removeImage();
                
                // Reset ingredients
                clearIngredients();
                
                // Reset custom category
                document.getElementById('customCategory').value = '';
                
                // Reset steps
                document.querySelectorAll('#uploadSteps li').forEach(li => {
                    li.style.color = '';
                });
                
                showMessage('Form has been reset', 'info');
            }
        }

        // Generate unique ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Save product to server
        async function saveProductToServer(productData, imageBase64) {
            try {
                const token = localStorage.getItem('adminToken');
                
                if (!token) {
                    throw new Error('Admin authentication required');
                }

                // Step 1: Upload image to GitHub if exists
                let imageUrl = '';
                if (imageBase64 && selectedImage) {
                    showProgress(25);
                    showMessage('Uploading image to GitHub...', 'info');
                    
                    const imageUploadResponse = await fetch(CONFIG.API_ENDPOINTS.UPLOAD_IMAGE, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            imageBase64: imageBase64,
                            fileName: `${productData.name.toLowerCase().replace(/[^a-z0-9]/g, '-')}-${Date.now()}.jpg`,
                            productName: productData.name
                        })
                    });

                    if (!imageUploadResponse.ok) {
                        const error = await imageUploadResponse.json();
                        console.warn('GitHub upload failed:', error.message);
                        // Continue without image URL, server will handle fallback
                    } else {
                        const imageResult = await imageUploadResponse.json();
                        imageUrl = imageResult.imageUrl;
                        showProgress(50);
                        showMessage('Image uploaded successfully!', 'success');
                    }
                }

                // Step 2: Save product to database
                showProgress(75);
                showMessage('Saving product to database...', 'info');
                
                const serverData = {
                    name: productData.name,
                    price: productData.price,
                    category: productData.category,
                    description: productData.description,
                    ingredients: productData.ingredients.join(', '),
                    isAvailable: true,
                    imageUrl: imageUrl || ''
                };

                // Validate category
                if (!['nachos', 'desserts'].includes(serverData.category)) {
                    serverData.category = 'nachos'; // Default category
                }

                const response = await fetch(CONFIG.API_ENDPOINTS.CREATE_PRODUCT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(serverData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to save to server');
                }

                const result = await response.json();
                showProgress(100);
                
                return {
                    success: true,
                    server: result,
                    storage: 'server',
                    imageUrl: imageUrl
                };
                
            } catch (error) {
                console.error('Server save failed:', error);
                return {
                    success: false,
                    error: error.message,
                    storage: 'server'
                };
            }
        }

        // Save product to localStorage (fallback)
        function saveProductToLocalStorage(productData) {
            try {
                let products = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEY)) || [];
                productData.id = generateId();
                productData.createdAt = new Date().toISOString();
                products.push(productData);
                localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(products));
                
                if (productData.imageBase64) {
                    saveProductImage(productData.id, productData.imageBase64);
                }
                
                return {
                    success: true,
                    storage: 'local'
                };
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                return {
                    success: false,
                    error: error.message,
                    storage: 'local'
                };
            }
        }

        // Save product image to localStorage
        function saveProductImage(productId, imageBase64) {
            try {
                let images = JSON.parse(localStorage.getItem(CONFIG.IMAGE_STORAGE_KEY)) || {};
                images[productId] = imageBase64;
                localStorage.setItem(CONFIG.IMAGE_STORAGE_KEY, JSON.stringify(images));
            } catch (error) {
                console.error('Error saving image:', error);
            }
        }

        // Handle form submission
        document.getElementById('productForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validate form
            if (!validateForm()) return;
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            submitBtn.disabled = true;
            
            showProgress(10);
            
            try {
                // Collect form data
                const productData = {
                    name: document.getElementById('productName').value.trim(),
                    price: parseFloat(document.getElementById('productPrice').value).toFixed(2),
                    description: document.getElementById('productDescription').value.trim() || '',
                    ingredients: Array.from(document.querySelectorAll('.ingredient-input'))
                        .map(input => input.value.trim())
                        .filter(value => value),
                    category: selectedCategory,
                    customCategory: document.getElementById('customCategory').value.trim() || null,
                    imageBase64: selectedImageBase64 || null
                };
                
                let saveResult;
                
                if (isAdminMode) {
                    // Try to save to server first
                    saveResult = await saveProductToServer(productData, selectedImageBase64);
                    
                    if (!saveResult.success) {
                        showMessage(`Server save failed: ${saveResult.error}. Falling back to local storage.`, 'warning');
                        // Fallback to localStorage
                        saveResult = saveProductToLocalStorage(productData);
                    }
                } else {
                    // Guest mode: save to localStorage only
                    saveResult = saveProductToLocalStorage(productData);
                }
                
                if (saveResult.success) {
                    // Show success message
                    const storageType = saveResult.storage === 'server' ? 'Server & GitHub' : 'Local Storage';
                    const imageInfo = saveResult.imageUrl ? `<br><strong>Image URL:</strong> <a href="${saveResult.imageUrl}" target="_blank">View on GitHub</a>` : '';
                    const successMessage = `
                        <strong>✅ Product Added Successfully!</strong><br><br>
                        <strong>Name:</strong> ${productData.name}<br>
                        <strong>Price:</strong> ₱${productData.price}<br>
                        <strong>Category:</strong> ${productData.category}<br>
                        <strong>Storage:</strong> ${storageType}
                        ${imageInfo}<br>
                        <strong>Ingredients:</strong> ${productData.ingredients.join(', ')}<br><br>
                        The product will now appear in the ${getCategoryPage(productData.category)} page.
                    `;
                    
                    showMessage(successMessage, 'success');
                    
                    // Reset form after successful submission
                    setTimeout(() => {
                        resetForm();
                        hideProgress();
                    }, 3000);
                } else {
                    throw new Error(`Failed to save product: ${saveResult.error}`);
                }
                
            } catch (error) {
                console.error('Error:', error);
                showMessage(`Error: ${error.message}`, 'error');
                hideProgress();
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // Get category page name
        function getCategoryPage(category) {
            switch(category) {
                case 'nachos': return 'nachos.html';
                case 'desserts': return 'aifoodies.html';
                case 'drinks': return 'drinks.html';
                case 'specials': return 'index.html (specials section)';
                default: return 'main menu';
            }
        }

        // Form validation
        function validateForm() {
            const name = document.getElementById('productName').value;
            const price = document.getElementById('productPrice').value;
            
            if (!name.trim()) {
                showMessage('Product name is required', 'error');
                return false;
            }
            
            if (!price || parseFloat(price) <= 0) {
                showMessage('Please enter a valid price', 'error');
                return false;
            }
            
            if (!selectedCategory) {
                showMessage('Please select a category', 'error');
                return false;
            }
            
            // Validate ingredients
            const ingredients = Array.from(document.querySelectorAll('.ingredient-input'))
                .map(input => input.value.trim())
                .filter(value => value);
            
            if (ingredients.length === 0) {
                showMessage('Please add at least one ingredient', 'error');
                return false;
            }
            
            return true;
        }

        // Initialize drag and drop
        function initializeDragAndDrop() {
            const uploadContainer = document.getElementById('imageUploadContainer');
            
            if (uploadContainer) {
                uploadContainer.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.style.borderColor = '#ff6b35';
                    this.style.background = 'rgba(255, 107, 53, 0.1)';
                });
                
                uploadContainer.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    this.style.borderColor = '#bdc3c7';
                    this.style.background = '#f8f9fa';
                });
                
                uploadContainer.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.style.borderColor = '#bdc3c7';
                    this.style.background = '#f8f9fa';
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        // Create a fake event to reuse previewImage function
                        const event = {
                            target: {
                                files: files
                            }
                        };
                        previewImage(event);
                    }
                });
            }
        }

        // Navigation function
        function navigateTo(page) {
            window.location.href = page;
        }
    </script>
</body>
</html>